<style>

    body, html {
        margin: 0;
    }

    main {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: row;
        background-color: #f0f0f0;
    }

    #url {
        width: 100%;
        height: 40px;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
        background-color: #f0f0f0;
    }

    #submit {
        height: 40px;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
        cursor: pointer;
    }
</style>

<main>
    <button id="back"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path></svg></button>
    <button id="forward"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path></svg></button>
    <input id="url" placeholder="enter kulfi://... url and hit enter" type="text" />
    <button id="submit" type="button">Go</button>
    <span id="loading"></span>
</main>

<script>
    const urlInput = document.querySelector("#url");
    const loading = document.querySelector("#loading");

    const invoke = window.__TAURI__.core.invoke;
    const emitTo = window.__TAURI__.event.emitTo;
    const listen = window.__TAURI__.event.listen;

    urlInput.addEventListener("keydown", function(event) {
        if (event.key !== "Enter") {
            return;
        }

        goToUrl();
    });

    document.querySelector("#submit").addEventListener("click", goToUrl);

    listen("url-changed", (e) => {
        const url = e.payload;
        console.log("URL changed to:", url);
        urlInput.value = url;
    });

    document.querySelector("#back").addEventListener("click", () => {
        emitTo("browser_view", "nav-back")
          .then(() => {
            console.log("Request to go back one page emitted successfully.");
          })
          .catch(err => {
            console.error("Failed to request nav back request:", err);
          });
    });

    document.querySelector("#forward").addEventListener("click", () => {
        emitTo("browser_view", "nav-forward")
          .then(() => {
            console.log("Request to go forward one page emitted successfully.");
          })
          .catch(err => {
            console.error("Failed to request nav forward request:", err);
          });
    });

    function goToUrl() {
        const url = urlInput.value.trim();

        console.log("Button clicked, URL entered:", url);

        if (!validate(url)) {
            console.error("Invalid URL format:", url);
            console.info("Please enter a valid URL in the format \"kulfi://<id52>/\".");
            return;
        }

        loading.textContent = "Loading...";

        invoke("open_url", { url: url })
            .then(() => {
                console.log("URL opened successfully:", url);
            })
            .catch((error) => {
                console.error("Error opening URL:", error);
            })
            .finally(() => {
                loading.textContent = "";
            });
    }

    /**
    * @param {string} url - The URL to validate.
    * @returns {boolean} True if the URL is valid, false otherwise.
     *
     * // TODO: return validated url or null if invalid
    */
    function validate(url) {
        if (!url) {
            return false;
        }

        // TODO: if protocol is not included and first part is 52 char long
        //       then assume it is a kulfi url and add the protocol, if not
        //       then assume it is https and add the protocol.

        if (!url.toLowerCase().startsWith("kulfi://")) {
            return false;
        }

        const url_parts = url.split("/");

        if (url_parts.length < 3) {
            return false;
        }

        const id52 = url_parts[2];

        if (id52.length !== 52) {
            return false;
        }

        return true;
    }
</script>
